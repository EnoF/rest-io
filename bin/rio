#!/usr/bin/env node

const rio = require('commander');
const package = require('../package.json');
const fs = require('fs');
const version = package.version;

require('ts-node/register');

console.log(`
  ______ _______ _______ _______     _____  _____
 |_____/ |______ |______    |    ___   |   |     |
 |    \\_ |______ ______|    |        __|__ |_____|
`);

rio.version(version);

rio.option('-s, --src [value]', 'specify the target directory', src =>
    src)
  .option('-o, --out [value]', 'specify the output directory', out =>
    out);

rio.command('generate-docs')
  .alias('gd')
  .description('generate swagger docs from the rest-io resource models')
  .action((options) => {
    if (!isValid()) return;

    notifyGenerationParams();
    console.log('--- Resources ---');
    displayResources(rio.src);
    console.log('--- Resources ---');
  });

rio.parse(process.argv);

if (!rio.src || !rio.out) rio.help();

function isValid() {
  try {
    if (!rio.src) throw new Error('Invalid source provided');
    if (!rio.out) throw new Error('Invalid output directory provided');
    return true;
  } catch (error) {
    console.log('--- ERROR ---');
    console.error(error);
    console.log('--- ERROR ---');
    rio.help();
    return false;
  }
}

function notifyGenerationParams() {
  console.log('Swagger documentation - generation');
  console.log(`--- generating ---
    from: ${rio.src}
    to: ${rio.out}`);
  console.log('--- generating ---');
}

function displayResources(dir) {
  const content = fs.readdirSync(dir);
  content
    .filter(name => fs.statSync(`${dir}/${name}`).isDirectory())
    .forEach(name => displayResources(`${dir}/${name}`));

  content
    .filter(name => fs.statSync(`${dir}/${name}`).isFile())
    .forEach(name => console.log(`${dir}/${name}`));
}
